<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Web Scraping with Ruby – Chris Mytton</title>

    <meta property="og:title" content="Web Scraping with Ruby" />
    <meta name="author" content="Chris Mytton" />
    <meta property="og:locale" content="en_GB" />
    <meta name="description" content="" />
    <meta property="og:description" content="" />
    <link rel="canonical" href="https://www.chrismytton.com/2015/01/19/web-scraping-with-ruby/" />
    <meta property="og:url" content="https://www.chrismytton.com/2015/01/19/web-scraping-with-ruby/" />
    <meta property="og:site_name" content="Chris Mytton" />
    
    <meta property="og:image" content="https://www.chrismytton.com/assets/images/profile-October-2019-square.jpg">
    <meta name="twitter:card" content="summary" />
    
    <meta property="twitter:title" content="Web Scraping with Ruby" />
    <meta name="twitter:site" content="@chrismytton" />
    <meta name="twitter:creator" content="@chrismytton" />

    <link rel="stylesheet" href="/assets/css/main.css?4b6d05b26b86a817ac3eeaa18dc86be601c572d89fa003e06047bee87191454a">
    <link type="application/atom+xml" rel="alternate" href="/index.xml" title="Chris Mytton" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" href="/favicon.png">

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-58688654-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-58688654-2');
    </script>
  </head>

  <body>

    <div class="container">
      <header class="site-header clearfix">
        <div class="elsewhere">
  <a target="_blank" rel="noopener noreferrer me" href="https://www.youtube.com/chrismytton" title="Subscribe to my YouTube channel" aria-label="Subscribe to my YouTube channel">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M23,9.71a8.5,8.5,0,0,0-.91-4.13,2.92,2.92,0,0,0-1.72-1A78.36,78.36,0,0,0,12,4.27a78.45,78.45,0,0,0-8.34.3,2.87,2.87,0,0,0-1.46.74c-.9.83-1,2.25-1.1,3.45a48.29,48.29,0,0,0,0,6.48,9.55,9.55,0,0,0,.3,2,3.14,3.14,0,0,0,.71,1.36,2.86,2.86,0,0,0,1.49.78,45.18,45.18,0,0,0,6.5.33c3.5.05,6.57,0,10.2-.28a2.88,2.88,0,0,0,1.53-.78,2.49,2.49,0,0,0,.61-1,10.58,10.58,0,0,0,.52-3.4C23,13.69,23,10.31,23,9.71ZM9.74,14.85V8.66l5.92,3.11C14,12.69,11.81,13.73,9.74,14.85Z"/></svg>
  </a>
  <a target="_blank" rel="noopener noreferrer me" href="https://www.instagram.com/chrismytton/" title="Follow me on Instagram" aria-label="Follow me on Instagram">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M17.34,5.46h0a1.2,1.2,0,1,0,1.2,1.2A1.2,1.2,0,0,0,17.34,5.46Zm4.6,2.42a7.59,7.59,0,0,0-.46-2.43,4.94,4.94,0,0,0-1.16-1.77,4.7,4.7,0,0,0-1.77-1.15,7.3,7.3,0,0,0-2.43-.47C15.06,2,14.72,2,12,2s-3.06,0-4.12.06a7.3,7.3,0,0,0-2.43.47A4.78,4.78,0,0,0,3.68,3.68,4.7,4.7,0,0,0,2.53,5.45a7.3,7.3,0,0,0-.47,2.43C2,8.94,2,9.28,2,12s0,3.06.06,4.12a7.3,7.3,0,0,0,.47,2.43,4.7,4.7,0,0,0,1.15,1.77,4.78,4.78,0,0,0,1.77,1.15,7.3,7.3,0,0,0,2.43.47C8.94,22,9.28,22,12,22s3.06,0,4.12-.06a7.3,7.3,0,0,0,2.43-.47,4.7,4.7,0,0,0,1.77-1.15,4.85,4.85,0,0,0,1.16-1.77,7.59,7.59,0,0,0,.46-2.43c0-1.06.06-1.4.06-4.12S22,8.94,21.94,7.88ZM20.14,16a5.61,5.61,0,0,1-.34,1.86,3.06,3.06,0,0,1-.75,1.15,3.19,3.19,0,0,1-1.15.75,5.61,5.61,0,0,1-1.86.34c-1,.05-1.37.06-4,.06s-3,0-4-.06A5.73,5.73,0,0,1,6.1,19.8,3.27,3.27,0,0,1,5,19.05a3,3,0,0,1-.74-1.15A5.54,5.54,0,0,1,3.86,16c0-1-.06-1.37-.06-4s0-3,.06-4A5.54,5.54,0,0,1,4.21,6.1,3,3,0,0,1,5,5,3.14,3.14,0,0,1,6.1,4.2,5.73,5.73,0,0,1,8,3.86c1,0,1.37-.06,4-.06s3,0,4,.06a5.61,5.61,0,0,1,1.86.34A3.06,3.06,0,0,1,19.05,5,3.06,3.06,0,0,1,19.8,6.1,5.61,5.61,0,0,1,20.14,8c.05,1,.06,1.37.06,4S20.19,15,20.14,16ZM12,6.87A5.13,5.13,0,1,0,17.14,12,5.12,5.12,0,0,0,12,6.87Zm0,8.46A3.33,3.33,0,1,1,15.33,12,3.33,3.33,0,0,1,12,15.33Z"/></svg>
  </a>
  <a target="_blank" rel="noopener noreferrer me" href="https://twitter.com/chrismytton" title="Follow me on Twitter" aria-label="Follow me on Twitter">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg>
  </a>
  <a target="_blank" rel="noopener noreferrer me" href="https://github.com/chrismytton" title="Visit my GitHub" aria-label="Visit my GitHub">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
  </a>
  <a target="_blank" rel="noopener noreferrer" href="/index.xml" title="Subscribe to my feed" aria-label="Subscribe to my feed">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
  </a>
</div>

        <a class="logo" href="/">Chris Mytton</a>
        <div class="menu">
  <a href="/">Home</a>
  <a href="/articles/">Articles</a>
</div>

      </header>

      <main class="site-content">
        <div class="post">
  <header class="post-header">
    <h1 class="post-title">Web Scraping with Ruby</h1>
  </header>

  <article>

    <div class="post-content">
      
<p>Scraping the web with Ruby is easier than you might think. Let’s start with a simple example, I want to get a nicely formatted JSON array of objects representing all the showings for my <a href="http://www.cubecinema.com/programme">local independent cinema</a>.</p>

<p>First we need a way to download the html page that has all the listings on it. Ruby comes with an http client, <code>Net::HTTP</code>, and it also comes with a nice wrapper around it, <code>open-uri</code> <sup id="fnref:open-uri" role="doc-noteref"><a href="#fn:open-uri" class="footnote" rel="footnote">1</a></sup>. So the first thing we do is grab the html from the remote server.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'open-uri'</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">'http://www.cubecinema.com/programme'</span>
<span class="n">html</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</code></pre></div></div>

<p>Great, so we’ve got the page that we want to scrape, now we need to extract some information from it. The best tool for this job is Nokogiri. So we create a new Nokogiri instance using the html we just scraped.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'nokogiri'</span>

<span class="n">doc</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
</code></pre></div></div>

<p>Nokogiri is great because it allows us to query the html using CSS selectors, which, in my opinion, is much simpler than using xpath.</p>

<p>Ok, now we’ve got a document that we can query for the cinema listings. Each individual listing’s html structure is something like the following.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"showing"</span> <span class="na">id=</span><span class="s">"event_7557"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/programme/event/live-stand-up-monty-python-and-the-holy-grail,7557/"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"/media/diary/thumbnails/montypython2_1.png.500x300_q85_background-%23FFFFFF_crop-smart.jpg"</span> <span class="na">alt=</span><span class="s">"Picture for event Live stand up + Monty Python and the Holy Grail"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"tags"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/programme/view/comedy/"</span> <span class="na">class=</span><span class="s">"tag_comedy"</span><span class="nt">&gt;</span>comedy<span class="nt">&lt;/a&gt;</span> <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/programme/view/dvd/"</span> <span class="na">class=</span><span class="s">"tag_dvd"</span><span class="nt">&gt;</span>dvd<span class="nt">&lt;/a&gt;</span> <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/programme/view/film/"</span> <span class="na">class=</span><span class="s">"tag_film"</span><span class="nt">&gt;</span>film<span class="nt">&lt;/a&gt;</span> <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;h1&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/programme/event/live-stand-up-monty-python-and-the-holy-grail,7557/"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"pre_title"</span><span class="nt">&gt;</span>Comedy Combo presents<span class="nt">&lt;/span&gt;</span>
      Live stand up + Monty Python and the Holy Grail
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"post_title"</span><span class="nt">&gt;</span>Rare screening from 35mm!<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"event_details"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"start_and_pricing"</span><span class="nt">&gt;</span>
      Sat 20 December | 19:30
      <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"copy"</span><span class="nt">&gt;</span>Brave (and not so brave) Knights of the Round Table! Gain shelter from the vicious chicken of Bristol as we gather to bear witness to this 100% factually accurate retelling ... [<span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"more"</span> <span class="na">href=</span><span class="s">"/programme/event/live-stand-up-monty-python-and-the-holy-grail,7557/"</span><span class="nt">&gt;</span>more...<span class="nt">&lt;/a&gt;</span>]<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<h2 id="processing-the-html">Processing the html</h2>

<p>Each showing has the class <code>.showing</code>, so we can select all the showings on the page and loop over them, processing each one in turn.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">showings</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">doc</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'.showing'</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">showing</span><span class="o">|</span>
  <span class="n">showing_id</span> <span class="o">=</span> <span class="n">showing</span><span class="p">[</span><span class="s1">'id'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s1">'_'</span><span class="p">).</span><span class="nf">last</span><span class="p">.</span><span class="nf">to_i</span>
  <span class="n">tags</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'.tags a'</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">tag</span><span class="o">|</span> <span class="n">tag</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span> <span class="p">}</span>
  <span class="n">title_el</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'h1 a'</span><span class="p">)</span>
  <span class="n">title_el</span><span class="p">.</span><span class="nf">children</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">.</span><span class="nf">remove</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="s1">'span'</span> <span class="p">}</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">title_el</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span>
  <span class="n">dates</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.start_and_pricing'</span><span class="p">).</span><span class="nf">inner_html</span><span class="p">.</span><span class="nf">strip</span>
  <span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'&lt;br&gt;'</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">description</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.copy'</span><span class="p">).</span><span class="nf">text</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">'[more...]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">).</span><span class="nf">strip</span>
  <span class="n">showings</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span>
    <span class="ss">id: </span><span class="n">showing_id</span><span class="p">,</span>
    <span class="ss">title: </span><span class="n">title</span><span class="p">,</span>
    <span class="ss">tags: </span><span class="n">tags</span><span class="p">,</span>
    <span class="ss">dates: </span><span class="n">dates</span><span class="p">,</span>
    <span class="ss">description: </span><span class="n">description</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Lets break down the code above and see what each part is doing.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">showing_id</span> <span class="o">=</span> <span class="n">showing</span><span class="p">[</span><span class="s1">'id'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s1">'_'</span><span class="p">).</span><span class="nf">last</span><span class="p">.</span><span class="nf">to_i</span>
</code></pre></div></div>

<p>First we get the showing’s unique id, which is helpfully exposed as part of the html id attribute in the markup. Using square brackets allows us to access attributes of the element, so using the html above as an example the return value of <code>showing['id']</code> would be <code>"event_7557"</code>. We’re only interested in the integer id, so we split the resulting string on the underscore, <code>.split('_')</code> and then take the last element from that array and convert it to an integer, <code>.last.to_i</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tags</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'.tags a'</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">tag</span><span class="o">|</span> <span class="n">tag</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span> <span class="p">}</span>
</code></pre></div></div>

<p>Here we find all the tags for a showing by using the <code>.css</code> method, which returns an array of matching elements. We then map these elements and take the text content and strip it of any excess whitespace. For the html above this would return <code>["comedy", "dvd", "film"]</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title_el</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'h1 a'</span><span class="p">)</span>
<span class="n">title_el</span><span class="p">.</span><span class="nf">children</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">.</span><span class="nf">remove</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="s1">'span'</span> <span class="p">}</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">title_el</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span>
</code></pre></div></div>

<p>The code to get the title is a bit more involved because the title element in the html contains some extra spans with a prefix and a suffix. First we get the title element using <code>.at_css</code>, which returns a single matching element. Then we loop over the children of the title element and remove any spans. Finally with the spans gone we get the text of the title element and strip out any excess whitespace.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dates</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.start_and_pricing'</span><span class="p">).</span><span class="nf">inner_html</span><span class="p">.</span><span class="nf">strip</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'&lt;br&gt;'</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<p>This is the code for getting the date and time of a showing. It’s a bit involved because a showing can be on multiple days, and sometimes there is also pricing information in the same element. We’re mapping the dates that we find to <code>DateTime.parse</code> so that the result is an array of ruby <code>DateTime</code> objects.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">description</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.copy'</span><span class="p">).</span><span class="nf">text</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">'[more...]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">).</span><span class="nf">strip</span>
</code></pre></div></div>

<p>Getting the description is quite straightforward, the only real processing we have to do is remove the <code>[more...]</code> text using <code>.gsub</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">showings</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span>
    <span class="ss">id: </span><span class="n">showing_id</span><span class="p">,</span>
    <span class="ss">title: </span><span class="n">title</span><span class="p">,</span>
    <span class="ss">tags: </span><span class="n">tags</span><span class="p">,</span>
    <span class="ss">dates: </span><span class="n">dates</span><span class="p">,</span>
    <span class="ss">description: </span><span class="n">description</span>
  <span class="p">)</span>
</code></pre></div></div>

<p>With all the bits of the showing that we want in variables we can now push a hash representing the showing into our array of showings.</p>

<h2 id="output-json">Output JSON</h2>

<p>Now we’ve processed each showing and we’ve got an array of showings we can convert the result to JSON.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'json'</span>

<span class="nb">puts</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">pretty_generate</span><span class="p">(</span><span class="n">showings</span><span class="p">)</span>
</code></pre></div></div>

<p>This prints out the JSON encoded version of the showings, when running the script the output can be redirected to a file, or piped into another program for further processing.</p>

<h2 id="putting-it-all-together">Putting it all together</h2>

<p>With all the pieces in place we can now put the full version of the script together.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'open-uri'</span>
<span class="nb">require</span> <span class="s1">'nokogiri'</span>
<span class="nb">require</span> <span class="s1">'json'</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">'http://www.cubecinema.com/programme'</span>
<span class="n">html</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="n">doc</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">showings</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">doc</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'.showing'</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">showing</span><span class="o">|</span>
  <span class="n">showing_id</span> <span class="o">=</span> <span class="n">showing</span><span class="p">[</span><span class="s1">'id'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s1">'_'</span><span class="p">).</span><span class="nf">last</span><span class="p">.</span><span class="nf">to_i</span>
  <span class="n">tags</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'.tags a'</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">tag</span><span class="o">|</span> <span class="n">tag</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span> <span class="p">}</span>
  <span class="n">title_el</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'h1 a'</span><span class="p">)</span>
  <span class="n">title_el</span><span class="p">.</span><span class="nf">children</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">.</span><span class="nf">remove</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="s1">'span'</span> <span class="p">}</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">title_el</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span>
  <span class="n">dates</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.start_and_pricing'</span><span class="p">).</span><span class="nf">inner_html</span><span class="p">.</span><span class="nf">strip</span>
  <span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'&lt;br&gt;'</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">description</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.copy'</span><span class="p">).</span><span class="nf">text</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">'[more...]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">).</span><span class="nf">strip</span>
  <span class="n">showings</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span>
    <span class="ss">id: </span><span class="n">showing_id</span><span class="p">,</span>
    <span class="ss">title: </span><span class="n">title</span><span class="p">,</span>
    <span class="ss">tags: </span><span class="n">tags</span><span class="p">,</span>
    <span class="ss">dates: </span><span class="n">dates</span><span class="p">,</span>
    <span class="ss">description: </span><span class="n">description</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">pretty_generate</span><span class="p">(</span><span class="n">showings</span><span class="p">)</span>
</code></pre></div></div>

<p>If you save the above into a file called <code>scraper.rb</code> and run it with <code>ruby scraper.rb</code> then you should see the JSON representation of the events printed to stdout. It will look something like the following.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">7686</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Harry Dean Stanton - Partly Fiction"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"dcp"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"film"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"ttt"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"dates"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"2015-01-19T20:00:00+00:00"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"2015-01-20T20:00:00+00:00"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A mesmerizing, impressionistic portrait of the iconic actor in his intimate moments, with film clips from some of his 250 films and his own heart-breaking renditions of American folk songs. ..."</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">7519</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bang the Bore Audiovisual Spectacle: VA AA LR + Stephen Cornford + Seth Cooke"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"music"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"dates"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"2015-01-21T20:00:00+00:00"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"An evening of hacked TVs, 4 screen cinematic drone and electroacoustics. VAAALR: Vasco Alves, Adam Asnan and Louie Rice create spectacles using distress flares, C02 and junk electronics. Stephen Cornford: ..."</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>And that’s it! This is just a basic example of scraping. Things get a bit more complicated if the site you’re scraping requires you to login first, for those instances I recommend looking into <a href="/2015/01/22/advanced-web-scraping-with-mechanize/">mechanize</a>, which builds on top of Nokogiri.</p>

<p>Hopefully this introduction to scraping has given you some ideas for data that you want to turn into a more structured format using the scraping techniques described above.</p>

<p>Next post in this series: <a href="/2015/01/22/advanced-web-scraping-with-mechanize/">Advanced web scraping with Mechanize</a>.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:open-uri" role="doc-endnote">
      <p>While good for basic tasks like this, open-uri has <a href="https://bugs.ruby-lang.org/issues/3719">some issues</a> which mean you may want to look elsewhere for an http client to use in production. <a href="#fnref:open-uri" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

    </div>

    <footer>
      
        <div class="post-tags">
          <p>
            Tagged:
            
            <a href="/tags/#programming">#programming</a>
            
            <a href="/tags/#scraping">#scraping</a>
            
          </p>
        </div>
      
      <p class="post-date">Published 19 January 2015</p>
    </footer>


  </article>

</div>

      </main>
    </div>

    <footer class="container site-footer">
      <a class="logo" href="/">Chris Mytton</a>
      <div class="menu">
  <a href="/">Home</a>
  <a href="/articles/">Articles</a>
</div>

      <img class="profile rounded" alt="chrismytton" width="100" height="100" src="/assets/images/profile-October-2019-square.jpg"/>

<div class="mini-bio">
  <p>
    Hi! My name is Chris. I'm a Senior Developer at <a href="https://www.mysociety.org/">mySociety</a>. I'm currently working on <a href="https://fixmystreet.org">FixMyStreet</a>, a software platform for reporting local problems.
  </p>
  <p>
    This is my personal website where I share projects I've been working on and what I learn along the way.
  </p>
  <p>
    Find me on Twitter:&nbsp;<a target="_blank" rel="noopener noreferrer me" href="https://twitter.com/chrismytton">@chrismytton</a>
  </p>
  <p>
    Get in touch:&nbsp;<a target="_blank" rel="noopener noreferrer" href="mailto:mail@chrismytton.com">mail@chrismytton.com</a>
  </p>
</div>

      <div class="elsewhere">
  <a target="_blank" rel="noopener noreferrer me" href="https://www.youtube.com/chrismytton" title="Subscribe to my YouTube channel" aria-label="Subscribe to my YouTube channel">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M23,9.71a8.5,8.5,0,0,0-.91-4.13,2.92,2.92,0,0,0-1.72-1A78.36,78.36,0,0,0,12,4.27a78.45,78.45,0,0,0-8.34.3,2.87,2.87,0,0,0-1.46.74c-.9.83-1,2.25-1.1,3.45a48.29,48.29,0,0,0,0,6.48,9.55,9.55,0,0,0,.3,2,3.14,3.14,0,0,0,.71,1.36,2.86,2.86,0,0,0,1.49.78,45.18,45.18,0,0,0,6.5.33c3.5.05,6.57,0,10.2-.28a2.88,2.88,0,0,0,1.53-.78,2.49,2.49,0,0,0,.61-1,10.58,10.58,0,0,0,.52-3.4C23,13.69,23,10.31,23,9.71ZM9.74,14.85V8.66l5.92,3.11C14,12.69,11.81,13.73,9.74,14.85Z"/></svg>
  </a>
  <a target="_blank" rel="noopener noreferrer me" href="https://www.instagram.com/chrismytton/" title="Follow me on Instagram" aria-label="Follow me on Instagram">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M17.34,5.46h0a1.2,1.2,0,1,0,1.2,1.2A1.2,1.2,0,0,0,17.34,5.46Zm4.6,2.42a7.59,7.59,0,0,0-.46-2.43,4.94,4.94,0,0,0-1.16-1.77,4.7,4.7,0,0,0-1.77-1.15,7.3,7.3,0,0,0-2.43-.47C15.06,2,14.72,2,12,2s-3.06,0-4.12.06a7.3,7.3,0,0,0-2.43.47A4.78,4.78,0,0,0,3.68,3.68,4.7,4.7,0,0,0,2.53,5.45a7.3,7.3,0,0,0-.47,2.43C2,8.94,2,9.28,2,12s0,3.06.06,4.12a7.3,7.3,0,0,0,.47,2.43,4.7,4.7,0,0,0,1.15,1.77,4.78,4.78,0,0,0,1.77,1.15,7.3,7.3,0,0,0,2.43.47C8.94,22,9.28,22,12,22s3.06,0,4.12-.06a7.3,7.3,0,0,0,2.43-.47,4.7,4.7,0,0,0,1.77-1.15,4.85,4.85,0,0,0,1.16-1.77,7.59,7.59,0,0,0,.46-2.43c0-1.06.06-1.4.06-4.12S22,8.94,21.94,7.88ZM20.14,16a5.61,5.61,0,0,1-.34,1.86,3.06,3.06,0,0,1-.75,1.15,3.19,3.19,0,0,1-1.15.75,5.61,5.61,0,0,1-1.86.34c-1,.05-1.37.06-4,.06s-3,0-4-.06A5.73,5.73,0,0,1,6.1,19.8,3.27,3.27,0,0,1,5,19.05a3,3,0,0,1-.74-1.15A5.54,5.54,0,0,1,3.86,16c0-1-.06-1.37-.06-4s0-3,.06-4A5.54,5.54,0,0,1,4.21,6.1,3,3,0,0,1,5,5,3.14,3.14,0,0,1,6.1,4.2,5.73,5.73,0,0,1,8,3.86c1,0,1.37-.06,4-.06s3,0,4,.06a5.61,5.61,0,0,1,1.86.34A3.06,3.06,0,0,1,19.05,5,3.06,3.06,0,0,1,19.8,6.1,5.61,5.61,0,0,1,20.14,8c.05,1,.06,1.37.06,4S20.19,15,20.14,16ZM12,6.87A5.13,5.13,0,1,0,17.14,12,5.12,5.12,0,0,0,12,6.87Zm0,8.46A3.33,3.33,0,1,1,15.33,12,3.33,3.33,0,0,1,12,15.33Z"/></svg>
  </a>
  <a target="_blank" rel="noopener noreferrer me" href="https://twitter.com/chrismytton" title="Follow me on Twitter" aria-label="Follow me on Twitter">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg>
  </a>
  <a target="_blank" rel="noopener noreferrer me" href="https://github.com/chrismytton" title="Visit my GitHub" aria-label="Visit my GitHub">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
  </a>
  <a target="_blank" rel="noopener noreferrer" href="/index.xml" title="Subscribe to my feed" aria-label="Subscribe to my feed">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/></svg>
  </a>
</div>

    </footer>

  </body>

</html>
