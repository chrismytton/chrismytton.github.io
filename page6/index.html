<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chris Mytton</title>

    <meta property="og:title" content="Chris Mytton" />
    <meta name="author" content="Chris Mytton" />
    <meta property="og:locale" content="en_GB" />
    <meta name="description" content="I'm a Developer at mySociety. This is my personal website." />
    <meta property="og:description" content="I'm a Developer at mySociety. This is my personal website." />
    <link rel="canonical" href="https://www.chrismytton.uk/page6/" />
    <meta property="og:url" content="https://www.chrismytton.uk/page6/" />
    <meta property="og:site_name" content="Chris Mytton" />
    <!-- <link rel="next" href="https://www.chrismytton.uk/page2" /> -->
    
    <meta name="twitter:card" content="summary" />
    
    <meta property="twitter:title" content="Chris Mytton" />
    <meta name="twitter:site" content="@chrismytton" />
    <meta name="twitter:creator" content="@chrismytton" />

    <link rel="stylesheet" href="/assets/css/main.css">
    <link type="application/atom+xml" rel="alternate" href="/index.xml" title="Chris Mytton" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" href="/favicon.png">
  </head>

  <body>

    <div class="container">
      <header class="site-header">
        <h1>
          <a class="logo" href="/">Chris Mytton</a>
        </h1>
      </header>

      <main class="site-content">
        
<article class="post">

  <header class="post-header">
    <h2 class="post-title"><a href="/2017/11/26/gloucester-cathedral/">Gloucester Cathedral</a></h2>
    <p class="post-date">Sunday 26 November 2017</p>
  </header>

  <div class="post-content">
    
<p><a href="/assets/images/gloucester-cathedral-outside.jpg"><img src="/assets/images/gloucester-cathedral-outside.jpg" alt="Outside of Gloucester Cathedral" /></a></p>

<p>We visited <a href="http://www.gloucestercathedral.org.uk/">Gloucester Cathedral</a> yesterday. The cathedral is over 1000 years old and is built in a mix Romanesque and Gothic style architecture. It has a stained glass window that depicts the earliest known images of golf that dates from 1350, sadly I didn’t get a picture of it.</p>

<p><a href="/assets/images/gloucester-cathedral-st-benedict.jpg"><img src="/assets/images/gloucester-cathedral-st-benedict.jpg" alt="St. Benedict on a stone outside Gloucester Cathedral" /></a></p>

<p>They’re currently doing some work around the cathedral as part of <a href="http://www.gloucestercathedral.org.uk/project-pilgrim/">Project Pilgrim</a>. This is one of the unfinished stones depicting Saint Benedict which is going to make up part of a new seating area outside the cathedral.</p>

<p><a href="/assets/images/gloucester-cathedral-cloisters.jpg"><img src="/assets/images/gloucester-cathedral-cloisters.jpg" alt="Gloucester Cathedral cloisters" /></a></p>

<p>The cathedral’s magnificent cloisters. Used as a filming location in a few of the Harry Potter films.</p>

<p><a href="/assets/images/gloucester-cathedral-inside.jpg"><img src="/assets/images/gloucester-cathedral-inside.jpg" alt="Inside of Gloucester Cathedral" /></a></p>

<p>Inside the cathedral looking west towards the choir and organ.</p>

  </div>

  <p class="permalink"><a href="/2017/11/26/gloucester-cathedral/">Permalink</a></p>
</article>

<article class="post">

  <header class="post-header">
    <h2 class="post-title"><a href="/2016/10/17/ruby-hash-find_all-select-different/">In Ruby, &#35;find_all and &#35;select are different (for Hashes)</a></h2>
    <p class="post-date">Monday 17 October 2016</p>
  </header>

  <div class="post-content">
    
<p>In Ruby, <a href="http://ruby-doc.org/core-2.3.1/Hash.html#method-i-select"><code class="highlighter-rouge">Hash#select</code> returns a <code class="highlighter-rouge">Hash</code></a> whereas <a href="http://ruby-doc.org/core-2.3.1/Enumerable.html#method-i-find_all"><code class="highlighter-rouge">Hash#find_all</code> returns an <code class="highlighter-rouge">Array</code></a>.</p>

<p>This is because Ruby’s <code class="highlighter-rouge">Hash</code> class defines its own <code class="highlighter-rouge">#select</code> method, but inherits its <code class="highlighter-rouge">#find_all</code> method from the <code class="highlighter-rouge">Enumerable</code> module.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># select returns a Hash</span>
<span class="p">{</span> <span class="ss">foo: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">bar: </span><span class="mi">2</span> <span class="p">}.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="n">value</span><span class="p">.</span><span class="nf">even?</span> <span class="p">}</span>
<span class="c1"># =&gt; { :bar =&gt; 2 }</span>

<span class="c1"># find_all returns an Array</span>
<span class="p">{</span> <span class="ss">foo: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">bar: </span><span class="mi">2</span> <span class="p">}.</span><span class="nf">find_all</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="n">value</span><span class="p">.</span><span class="nf">even?</span> <span class="p">}</span>
<span class="c1"># =&gt; [[:bar, 2]]</span>
</code></pre></div></div>

<p>For more details see <a href="http://stackoverflow.com/a/21000136">this StackOverflow answer</a>.</p>

  </div>

  <p class="permalink"><a href="/2016/10/17/ruby-hash-find_all-select-different/">Permalink</a></p>
</article>

<article class="post">

  <header class="post-header">
    <h2 class="post-title"><a href="/2016/10/11/using-nokogiri-with-pry/">Using nokogiri with pry</a></h2>
    <p class="post-date">Tuesday 11 October 2016</p>
  </header>

  <div class="post-content">
    
<p>I wanted a quick way to run some XPath selectors against a web page today. <a href="http://www.nokogiri.org/">Nokogiri</a> comes with a command line tool that you can pass a url and it will drop you into an IRB session. This allows you to play around with some Ruby code to explore a webpage before scraping it.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nokogiri http://example.com
</code></pre></div></div>

<p>This is useful, but I wanted to use it with <a href="http://pryrepl.org/">Pry</a>. It turns out that adding support for Pry is relatively easy, but I couldn’t find any clear top to bottom instructions, so I’ve documented the process below.</p>

<p>First install Nokogiri and Pry:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gem install nokogiri pry
</code></pre></div></div>

<p>Then add the following code to <code class="highlighter-rouge">~/.nokogirirc</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'pry'</span>
<span class="no">Nokogiri</span><span class="o">::</span><span class="no">CLI</span><span class="p">.</span><span class="nf">console</span> <span class="o">=</span> <span class="no">Pry</span>
</code></pre></div></div>

<p>That’s it! Now when you use the <code class="highlighter-rouge">nokogiri</code> command line tool it will now drop you into a pry REPL. This is perfect for testing your CSS and XPath selectors when you’re <a href="https://www.chrismytton.uk/2015/01/19/web-scraping-with-ruby/">writing a scraper</a>.</p>

<noscript>
<a href="https://asciinema.org/a/88853" target="_blank"><img src="https://asciinema.org/a/88853.png" /></a>
</noscript>
<script type="text/javascript" src="https://asciinema.org/a/88853.js" id="asciicast-88853" async=""></script>


  </div>

  <p class="permalink"><a href="/2016/10/11/using-nokogiri-with-pry/">Permalink</a></p>
</article>

<article class="post">

  <header class="post-header">
    <h2 class="post-title"><a href="/2015/02/06/web-scraping-with-morph-io/">Web scraping with morph.io</a></h2>
    <p class="post-date">Friday 6 February 2015</p>
  </header>

  <div class="post-content">
    
<p>If you’ve followed along my previous two blog posts, <a href="/2015/01/19/web-scraping-with-ruby/">Web Scraping with Ruby</a> and <a href="/2015/01/22/advanced-web-scraping-with-mechanize/">Advanced web scraping with Mechanize</a> then you’ll now have the knowledge needed to write a basic web scraper for getting structured data from the web.</p>

<p>The next logical step is to actually run these scrapers regularly so you can get information that’s constantly up-to-date. This is where the excellent <a href="https://morph.io/">morph.io</a> from the talented folks at <a href="https://www.openaustraliafoundation.org.au/">OpenAustralia</a> comes into play.</p>

<p>Morph.io bills itself as “A Heroku for Scrapers”.  You can choose to either run your scrapers manually, or have them run automatically for you every day. Then you can use the morph.io API to extract the data for use in your application as JSON, CSV or you can download a sqlite database containing the scraped data.</p>

<p>Morph.io fills the gap that <a href="https://classic.scraperwiki.com/">Scraperwiki Classic</a> left. Morph.io scrapers are hosted on GitHub, which means you can fork them and fix them if they break in the future.</p>

<h2 id="creating-a-scraper">Creating a scraper</h2>

<p>We’ll use the code from the <a href="/2015/01/22/advanced-web-scraping-with-mechanize/#all-together-now">Pitchfork Scraper</a> in my previous post to demonstrate how easy it is to get your scraper running on morph.io.</p>

<p>You can sign into morph.io with a GitHub account. Once signed in you can then <a href="https://morph.io/scrapers/new">create a scraper</a>. Currently morph.io supports scrapers written in Ruby, PHP, Python or Perl, choose a language and give your scraper a name, I’m calling mine <code class="highlighter-rouge">pitchfork_scraper</code>. Then press the “Create Scraper” button to create a new GitHub repository containing skeleton code for a scraper in your chosen language.</p>

<p>Clone the repository that was created in the previous step, in my case I can use the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/chrismytton/pitchfork_scraper
</code></pre></div></div>

<p>The repository will contain a <code class="highlighter-rouge">README.md</code> and a <code class="highlighter-rouge">scraper.rb</code> file.</p>

<p>Morph.io expects two things from your scraper. First the scraper repository should contain a <code class="highlighter-rouge">scraper.rb</code> file for Ruby scrapers <sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>, second the scraper itself should write to a sqlite3 database file called <code class="highlighter-rouge">data.sqlite</code>. In order to change this in our scraper we need to make a small change so it writes to a database rather than to JSON on STDOUT.</p>

<p>First add the <a href="/2015/01/22/advanced-web-scraping-with-mechanize/#all-together-now">code from the previous post</a> into <code class="highlighter-rouge">scraper.rb</code>, then you can change the code to use the <code class="highlighter-rouge">scraperwiki</code> gem to write to the sqlite database.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh">diff --git a/scraper.rb b/scraper.rb
index 2d2baaa..f8b14d6 100644
</span><span class="gd">--- a/scraper.rb
</span><span class="gi">+++ b/scraper.rb
</span><span class="p">@@ -1,6 +1,8 @@</span>
 require 'mechanize'
 require 'date'
<span class="gd">-require 'json'
</span><span class="gi">+require 'scraperwiki'
+
+ScraperWiki.config = { db: 'data.sqlite', default_table_name: 'data' }
</span>
 agent = Mechanize.new
 page = agent.get("http://pitchfork.com/reviews/albums/")
<span class="p">@@ -34,4 +36,6 @@</span> reviews = review_links.map do |link|
   }
 end

-puts JSON.pretty_generate(reviews)
<span class="gi">+reviews.each do |review|
+  ScraperWiki.save_sqlite([:artist, :album], review)
+end
</span></code></pre></div></div>

<p>This uses the <code class="highlighter-rouge">ScraperWiki.save_sqlite</code> method to save the review in the database. The first argument is the list of fields that in combination should be considered unique. In this case we’re using the artist and album, since it’s unlikely that an artist would release two albums with the same name.</p>

<p>You’ll need to install the Ruby <code class="highlighter-rouge">scraperwiki</code> gem in addition to the other dependencies to run this code locally.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gem install scraperwiki
</code></pre></div></div>

<p>Then you can run this code on your local machine with the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ruby scraper.rb
</code></pre></div></div>

<p>This will create a new file in the current directory called <code class="highlighter-rouge">data.sqlite</code> which will contain the scraped data.</p>

<h2 id="running-the-scraper-on-morphio">Running the scraper on morph.io</h2>

<p>Now you’ve made the changes to your scraper you can run the code on <a href="https://morph.io/">morph.io</a>. First commit your changes using <code class="highlighter-rouge">git</code>. Then <code class="highlighter-rouge">git push</code> the changes to the scrapers GitHub repository.</p>

<p>You can then run the scraper and the results should be added to the corresponding sqlite database on morph.io. It should look something like the following:</p>

<p><img src="/assets/images/pitchfork_scraper.png" alt="Screenshot of morph.io output" /></p>

<p>As you can see the data is now available to authorized users as either JSON, CSV or you can download the sqlite database and use that locally.</p>

<p>The code for the scraper is <a href="https://github.com/chrismytton/pitchfork_scraper">available on GitHub</a>. You can see the output from the scraper on morph.io <a href="https://morph.io/chrismytton/pitchfork_scraper">morph.io/chrismytton/pitchfork_scraper</a>. Note that you’ll need to sign in with GitHub in order to access and manipulate the data over the API.</p>

<p>This article should give you enough background to start hosting your scrapers on <a href="https://morph.io/">morph.io</a>. In my opinion it’s an awesome service that takes the hassle out of running and maintaining scrapers and leaves you to concentrate on the unique parts of your application.</p>

<p>Go forth and get structured data out of the web!</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Alternatively <code class="highlighter-rouge">scraper.py</code> for Python, <code class="highlighter-rouge">scraper.php</code> for PHP or <code class="highlighter-rouge">scraper.pl</code> for Perl <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <p class="permalink"><a href="/2015/02/06/web-scraping-with-morph-io/">Permalink</a></p>
</article>

<article class="post">

  <header class="post-header">
    <h2 class="post-title"><a href="/2015/01/22/advanced-web-scraping-with-mechanize/">Advanced web scraping with Mechanize</a></h2>
    <p class="post-date">Thursday 22 January 2015</p>
  </header>

  <div class="post-content">
    
<p>In my last post I gave a basic <a href="/2015/01/19/web-scraping-with-ruby/">introduction to web scraping with Ruby and Nokogiri</a>. At the end of that post I mentioned that for more “advanced” scraping Mechanize was worth looking into.</p>

<p>This post explains how to do some more advanced web scraping using Mechanize, which builds on top of Nokogiri’s excellent HTML processing support.</p>

<h2 id="scraping-pitchfork-reviews">Scraping Pitchfork reviews</h2>

<p>Mechanize provides an out-of-the-box scraping solution that can handle filling in forms, following links and respecting a site’s robots.txt file. Here I’ll show you how it can be used to scrape the latest reviews from <a href="http://pitchfork.com/">Pitchfork</a> <sup id="fnref:disclaimer"><a href="#fn:disclaimer" class="footnote">1</a></sup>.</p>

<p>Reviews are spread across multiple pages, so we can’t simply fetch a single page and parse it with Nokogiri. This is where Mechanize can help with its ability to click on links and follow them to other pages.</p>

<h3 id="setup">Setup</h3>

<p>First we’ll need to install <a href="http://docs.seattlerb.org/mechanize/GUIDE_rdoc.html">Mechanize</a> and its dependencies from Rubygems.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gem install mechanize
</code></pre></div></div>

<p>With Mechanize installed we can now start writing our scraper. Create a file called <code class="highlighter-rouge">scraper.rb</code> and add the following <code class="highlighter-rouge">require</code> statements. These specify the dependencies we need for this script. <code class="highlighter-rouge">date</code> and <code class="highlighter-rouge">json</code> are part of Ruby’s standard library, so there’s no need to install them separately.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'mechanize'</span>
<span class="nb">require</span> <span class="s1">'date'</span>
<span class="nb">require</span> <span class="s1">'json'</span>
</code></pre></div></div>

<p>Now we can start using Mechanize. First thing we need to do is create a new instance of Mechanize (<code class="highlighter-rouge">agent</code>) and then use it to fetch a remote webpage (<code class="highlighter-rouge">page</code>).</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">agent</span> <span class="o">=</span> <span class="no">Mechanize</span><span class="p">.</span><span class="nf">new</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">agent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s2">"http://pitchfork.com/reviews/albums/"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="find-links-to-reviews">Find links to reviews</h3>

<p>Now we can use the <code class="highlighter-rouge">page</code> object to find links to reviews. Mechanize provides a <code class="highlighter-rouge">.links_with</code> method which, as the name suggests, finds links with the given attributes. Here we look for links which match a regular expression.</p>

<p>This returns an array of links, but we only want links to reviews, not pagination. To remove unwanted links we can call <code class="highlighter-rouge">.reject</code> on the array of links and reject any which look like pagination links.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">review_links</span> <span class="o">=</span> <span class="n">page</span><span class="p">.</span><span class="nf">links_with</span><span class="p">(</span><span class="ss">href: </span><span class="sr">%r{^/reviews/albums/</span><span class="se">\w</span><span class="sr">+}</span><span class="p">)</span>

<span class="n">review_links</span> <span class="o">=</span> <span class="n">review_links</span><span class="p">.</span><span class="nf">reject</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
  <span class="n">parent_classes</span> <span class="o">=</span> <span class="n">link</span><span class="p">.</span><span class="nf">node</span><span class="p">.</span><span class="nf">parent</span><span class="p">[</span><span class="s1">'class'</span><span class="p">].</span><span class="nf">split</span>
  <span class="n">parent_classes</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="sx">%w[next-container page-number]</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="nb">p</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>For the purposes of demonstration—and so we don’t completely hammer Pitchfork’s server’s—we’ll just take the first four review links.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">review_links</span> <span class="o">=</span> <span class="n">review_links</span><span class="p">[</span><span class="mi">0</span><span class="o">...</span><span class="mi">4</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="process-each-review">Process each review</h3>

<p>We now have a list of Mechanize links which we want to map to the reviews that they link to. Since they’re in an array we can call <code class="highlighter-rouge">.map</code> on it and return a hash from each iteration.</p>

<p>The Mechanize <code class="highlighter-rouge">page</code> object has a <code class="highlighter-rouge">.search</code> method which delegates to Nokogiri’s <code class="highlighter-rouge">.search</code> method. This means that we can use a CSS selector as an argument to <code class="highlighter-rouge">.search</code> and it will return an array of matching elements.</p>

<p>Here we first get the review metadata using the CSS selector <code class="highlighter-rouge">#main .review-meta .info</code> and then search inside the <code class="highlighter-rouge">review_meta</code> element for the various bits of information that we need.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">reviews</span> <span class="o">=</span> <span class="n">review_links</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
  <span class="n">review</span> <span class="o">=</span> <span class="n">link</span><span class="p">.</span><span class="nf">click</span>
  <span class="n">review_meta</span> <span class="o">=</span> <span class="n">review</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'#main .review-meta .info'</span><span class="p">)</span>
  <span class="n">artist</span> <span class="o">=</span> <span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">text</span>
  <span class="n">album</span> <span class="o">=</span> <span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'h2'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">text</span>
  <span class="n">label</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'h3'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">text</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">)</span>
  <span class="n">reviewer</span> <span class="o">=</span> <span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'h4 address'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">text</span>
  <span class="n">review_date</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'.pub-date'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">text</span><span class="p">)</span>
  <span class="n">score</span> <span class="o">=</span> <span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'.score'</span><span class="p">).</span><span class="nf">text</span><span class="p">.</span><span class="nf">to_f</span>
  <span class="p">{</span>
    <span class="ss">artist: </span><span class="n">artist</span><span class="p">,</span>
    <span class="ss">album: </span><span class="n">album</span><span class="p">,</span>
    <span class="ss">label: </span><span class="n">label</span><span class="p">,</span>
    <span class="ss">year: </span><span class="n">year</span><span class="p">,</span>
    <span class="ss">reviewer: </span><span class="n">reviewer</span><span class="p">,</span>
    <span class="ss">review_date: </span><span class="n">review_date</span><span class="p">,</span>
    <span class="ss">score: </span><span class="n">score</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now we’ve got an array of review hashes we can output the reviews in JSON format.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">puts</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">pretty_generate</span><span class="p">(</span><span class="n">reviews</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="all-together-now">All together now</h3>

<p>Here’s the whole script:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'mechanize'</span>
<span class="nb">require</span> <span class="s1">'date'</span>
<span class="nb">require</span> <span class="s1">'json'</span>

<span class="n">agent</span> <span class="o">=</span> <span class="no">Mechanize</span><span class="p">.</span><span class="nf">new</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">agent</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s2">"http://pitchfork.com/reviews/albums/"</span><span class="p">)</span>

<span class="n">review_links</span> <span class="o">=</span> <span class="n">page</span><span class="p">.</span><span class="nf">links_with</span><span class="p">(</span><span class="ss">href: </span><span class="sr">%r{^/reviews/albums/</span><span class="se">\w</span><span class="sr">+}</span><span class="p">)</span>

<span class="n">review_links</span> <span class="o">=</span> <span class="n">review_links</span><span class="p">.</span><span class="nf">reject</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
  <span class="n">parent_classes</span> <span class="o">=</span> <span class="n">link</span><span class="p">.</span><span class="nf">node</span><span class="p">.</span><span class="nf">parent</span><span class="p">[</span><span class="s1">'class'</span><span class="p">].</span><span class="nf">split</span>
  <span class="n">parent_classes</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="sx">%w[next-container page-number]</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="nb">p</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">review_links</span> <span class="o">=</span> <span class="n">review_links</span><span class="p">[</span><span class="mi">0</span><span class="o">...</span><span class="mi">4</span><span class="p">]</span>

<span class="n">reviews</span> <span class="o">=</span> <span class="n">review_links</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
  <span class="n">review</span> <span class="o">=</span> <span class="n">link</span><span class="p">.</span><span class="nf">click</span>
  <span class="n">review_meta</span> <span class="o">=</span> <span class="n">review</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'#main .review-meta .info'</span><span class="p">)</span>
  <span class="n">artist</span> <span class="o">=</span> <span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">text</span>
  <span class="n">album</span> <span class="o">=</span> <span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'h2'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">text</span>
  <span class="n">label</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'h3'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">text</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">)</span>
  <span class="n">reviewer</span> <span class="o">=</span> <span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'h4 address'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">text</span>
  <span class="n">review_date</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'.pub-date'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">text</span><span class="p">)</span>
  <span class="n">score</span> <span class="o">=</span> <span class="n">review_meta</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'.score'</span><span class="p">).</span><span class="nf">text</span><span class="p">.</span><span class="nf">to_f</span>
  <span class="p">{</span>
    <span class="ss">artist: </span><span class="n">artist</span><span class="p">,</span>
    <span class="ss">album: </span><span class="n">album</span><span class="p">,</span>
    <span class="ss">label: </span><span class="n">label</span><span class="p">,</span>
    <span class="ss">year: </span><span class="n">year</span><span class="p">,</span>
    <span class="ss">reviewer: </span><span class="n">reviewer</span><span class="p">,</span>
    <span class="ss">review_date: </span><span class="n">review_date</span><span class="p">,</span>
    <span class="ss">score: </span><span class="n">score</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">pretty_generate</span><span class="p">(</span><span class="n">reviews</span><span class="p">)</span>
</code></pre></div></div>

<p>Put this code in a file called <code class="highlighter-rouge">scraper.rb</code> and run it with the following.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ruby scraper.rb
</code></pre></div></div>

<p>And it should output something like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"artist"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Viet Cong"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"album"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Viet Cong"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jagjaguwar"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"year"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"reviewer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ian Cohen"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"review_date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-01-22"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"score"</span><span class="p">:</span><span class="w"> </span><span class="mf">8.5</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"artist"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Lupe Fiasco"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"album"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tetsuo &amp; Youth"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Atlantic / 1st and 15th"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"year"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"reviewer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jayson Greene"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"review_date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-01-22"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"score"</span><span class="p">:</span><span class="w"> </span><span class="mf">7.2</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"artist"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The Go-Betweens"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"album"</span><span class="p">:</span><span class="w"> </span><span class="s2">"G Stands for Go-Betweens: Volume 1, 1978-1984"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Domino"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"year"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"reviewer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Douglas Wolk"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"review_date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-01-22"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"score"</span><span class="p">:</span><span class="w"> </span><span class="mf">8.2</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"artist"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The Sidekicks"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"album"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Runners in the Nerved World"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Epitaph"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"year"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"reviewer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ian Cohen"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"review_date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-01-22"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"score"</span><span class="p">:</span><span class="w"> </span><span class="mf">7.4</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>If you want, you can save this JSON to a file by redirecting standard out to a file.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ruby scraper.rb &gt; reviews.json
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>This only scratches the surface of Mechanize. One thing I haven’t even touched on is it’s ability to fill in and submit forms. If you’re interested in learning more then I recommend you look at the <a href="http://docs.seattlerb.org/mechanize/GUIDE_rdoc.html">Mechanize guide</a> and <a href="http://docs.seattlerb.org/mechanize/EXAMPLES_rdoc.html">Mechanize examples</a>.</p>

<p>A lot of people commented that my <a href="/2015/01/19/web-scraping-with-ruby/">previous post</a> should have just used Mechanize from the off. While I agree that Mechanize is a great tool, for simple tasks like the one I presented, at the time it seemed to me like a bit of an overkill.</p>

<p>However on reflection the fact that <a href="http://docs.seattlerb.org/mechanize/GUIDE_rdoc.html">Mechanize</a> handles fetching the remote webpage and respects robots.txt files makes me think that, even for non-advanced scraping tasks, Mechanize will often be the best tool for the job.</p>

<div class="footnotes">
  <ol>
    <li id="fn:disclaimer">
      <p>You should always scrape responsibly. Check out the <a href="https://blog.scraperwiki.com/2012/04/is-scraping-legal/">Is scraping legal?</a> blog post from ScraperWiki for more discussion on the subject. <a href="#fnref:disclaimer" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <p class="permalink"><a href="/2015/01/22/advanced-web-scraping-with-mechanize/">Permalink</a></p>
</article>

<article class="post">

  <header class="post-header">
    <h2 class="post-title"><a href="/2015/01/19/web-scraping-with-ruby/">Web Scraping with Ruby</a></h2>
    <p class="post-date">Monday 19 January 2015</p>
  </header>

  <div class="post-content">
    
<p><strong>Update Jan 22</strong>: Check out the next post in this series: <a href="/2015/01/22/advanced-web-scraping-with-mechanize/">Advanced web scraping with Mechanize</a>.</p>

<p>Scraping the web with Ruby is easier than you might think. Let’s start with a simple example, I want to get a nicely formatted JSON array of objects representing all the showings for my <a href="http://www.cubecinema.com/programme">local independent cinema</a>.</p>

<p>First we need a way to download the html page that has all the listings on it. Ruby comes with an http client, <code class="highlighter-rouge">Net::HTTP</code>, and it also comes with a nice wrapper around it, <code class="highlighter-rouge">open-uri</code> <sup id="fnref:open-uri"><a href="#fn:open-uri" class="footnote">1</a></sup>. So the first thing we do is grab the html from the remote server.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'open-uri'</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">'http://www.cubecinema.com/programme'</span>
<span class="n">html</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</code></pre></div></div>

<p>Great, so we’ve got the page that we want to scrape, now we need to extract some information from it. The best tool for this job is <a href="http://www.nokogiri.org/">Nokogiri</a>. So we create a new Nokogiri instance using the html we just scraped.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'nokogiri'</span>

<span class="n">doc</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
</code></pre></div></div>

<p>Nokogiri is great because it allows us to query the html using CSS selectors, which, in my opinion, is much simpler than using xpath.</p>

<p>Ok, now we’ve got a document that we can query for the cinema listings. Each individual listing’s html structure is something like the following.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"showing"</span> <span class="na">id=</span><span class="s">"event_7557"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/programme/event/live-stand-up-monty-python-and-the-holy-grail,7557/"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"/media/diary/thumbnails/montypython2_1.png.500x300_q85_background-%23FFFFFF_crop-smart.jpg"</span> <span class="na">alt=</span><span class="s">"Picture for event Live stand up + Monty Python and the Holy Grail"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"tags"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/programme/view/comedy/"</span> <span class="na">class=</span><span class="s">"tag_comedy"</span><span class="nt">&gt;</span>comedy<span class="nt">&lt;/a&gt;</span> <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/programme/view/dvd/"</span> <span class="na">class=</span><span class="s">"tag_dvd"</span><span class="nt">&gt;</span>dvd<span class="nt">&lt;/a&gt;</span> <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/programme/view/film/"</span> <span class="na">class=</span><span class="s">"tag_film"</span><span class="nt">&gt;</span>film<span class="nt">&lt;/a&gt;</span> <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;h1&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/programme/event/live-stand-up-monty-python-and-the-holy-grail,7557/"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"pre_title"</span><span class="nt">&gt;</span>Comedy Combo presents<span class="nt">&lt;/span&gt;</span>
      Live stand up + Monty Python and the Holy Grail
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"post_title"</span><span class="nt">&gt;</span>Rare screening from 35mm!<span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"event_details"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"start_and_pricing"</span><span class="nt">&gt;</span>
      Sat 20 December | 19:30
      <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"copy"</span><span class="nt">&gt;</span>Brave (and not so brave) Knights of the Round Table! Gain shelter from the vicious chicken of Bristol as we gather to bear witness to this 100% factually accurate retelling ... [<span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"more"</span> <span class="na">href=</span><span class="s">"/programme/event/live-stand-up-monty-python-and-the-holy-grail,7557/"</span><span class="nt">&gt;</span>more...<span class="nt">&lt;/a&gt;</span>]<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<h2 id="processing-the-html">Processing the html</h2>

<p>Each showing has the class <code class="highlighter-rouge">.showing</code>, so we can select all the showings on the page and loop over them, processing each one in turn.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">showings</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">doc</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'.showing'</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">showing</span><span class="o">|</span>
  <span class="n">showing_id</span> <span class="o">=</span> <span class="n">showing</span><span class="p">[</span><span class="s1">'id'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s1">'_'</span><span class="p">).</span><span class="nf">last</span><span class="p">.</span><span class="nf">to_i</span>
  <span class="n">tags</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'.tags a'</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">tag</span><span class="o">|</span> <span class="n">tag</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span> <span class="p">}</span>
  <span class="n">title_el</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'h1 a'</span><span class="p">)</span>
  <span class="n">title_el</span><span class="p">.</span><span class="nf">children</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">.</span><span class="nf">remove</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="s1">'span'</span> <span class="p">}</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">title_el</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span>
  <span class="n">dates</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.start_and_pricing'</span><span class="p">).</span><span class="nf">inner_html</span><span class="p">.</span><span class="nf">strip</span>
  <span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'&lt;br&gt;'</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">description</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.copy'</span><span class="p">).</span><span class="nf">text</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">'[more...]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">).</span><span class="nf">strip</span>
  <span class="n">showings</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span>
    <span class="ss">id: </span><span class="n">showing_id</span><span class="p">,</span>
    <span class="ss">title: </span><span class="n">title</span><span class="p">,</span>
    <span class="ss">tags: </span><span class="n">tags</span><span class="p">,</span>
    <span class="ss">dates: </span><span class="n">dates</span><span class="p">,</span>
    <span class="ss">description: </span><span class="n">description</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Lets break down the code above and see what each part is doing.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">showing_id</span> <span class="o">=</span> <span class="n">showing</span><span class="p">[</span><span class="s1">'id'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s1">'_'</span><span class="p">).</span><span class="nf">last</span><span class="p">.</span><span class="nf">to_i</span>
</code></pre></div></div>

<p>First we get the showing’s unique id, which is helpfully exposed as part of the html id attribute in the markup. Using square brackets allows us to access attributes of the element, so using the html above as an example the return value of <code class="highlighter-rouge">showing['id']</code> would be <code class="highlighter-rouge">"event_7557"</code>. We’re only interested in the integer id, so we split the resulting string on the underscore, <code class="highlighter-rouge">.split('_')</code> and then take the last element from that array and convert it to an integer, <code class="highlighter-rouge">.last.to_i</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tags</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'.tags a'</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">tag</span><span class="o">|</span> <span class="n">tag</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span> <span class="p">}</span>
</code></pre></div></div>

<p>Here we find all the tags for a showing by using the <code class="highlighter-rouge">.css</code> method, which returns an array of matching elements. We then map these elements and take the text content and strip it of any excess whitespace. For the html above this would return <code class="highlighter-rouge">["comedy", "dvd", "film"]</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">title_el</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'h1 a'</span><span class="p">)</span>
<span class="n">title_el</span><span class="p">.</span><span class="nf">children</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">.</span><span class="nf">remove</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="s1">'span'</span> <span class="p">}</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">title_el</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span>
</code></pre></div></div>

<p>The code to get the title is a bit more involved because the title element in the html contains some extra spans with a prefix and a suffix. First we get the title element using <code class="highlighter-rouge">.at_css</code>, which returns a single matching element. Then we loop over the children of the title element and remove any spans. Finally with the spans gone we get the text of the title element and strip out any excess whitespace.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dates</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.start_and_pricing'</span><span class="p">).</span><span class="nf">inner_html</span><span class="p">.</span><span class="nf">strip</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'&lt;br&gt;'</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<p>This is the code for getting the date and time of a showing. It’s a bit involved because a showing can be on multiple days, and sometimes there is also pricing information in the same element. We’re mapping the dates that we find to <code class="highlighter-rouge">DateTime.parse</code> so that the result is an array of ruby <code class="highlighter-rouge">DateTime</code> objects.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">description</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.copy'</span><span class="p">).</span><span class="nf">text</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">'[more...]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">).</span><span class="nf">strip</span>
</code></pre></div></div>

<p>Getting the description is quite straightforward, the only real processing we have to do is remove the <code class="highlighter-rouge">[more...]</code> text using <code class="highlighter-rouge">.gsub</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">showings</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span>
    <span class="ss">id: </span><span class="n">showing_id</span><span class="p">,</span>
    <span class="ss">title: </span><span class="n">title</span><span class="p">,</span>
    <span class="ss">tags: </span><span class="n">tags</span><span class="p">,</span>
    <span class="ss">dates: </span><span class="n">dates</span><span class="p">,</span>
    <span class="ss">description: </span><span class="n">description</span>
  <span class="p">)</span>
</code></pre></div></div>

<p>With all the bits of the showing that we want in variables we can now push a hash representing the showing into our array of showings.</p>

<h2 id="output-json">Output JSON</h2>

<p>Now we’ve processed each showing and we’ve got an array of showings we can convert the result to JSON.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'json'</span>

<span class="nb">puts</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">pretty_generate</span><span class="p">(</span><span class="n">showings</span><span class="p">)</span>
</code></pre></div></div>

<p>This prints out the JSON encoded version of the showings, when running the script the output can be redirected to a file, or piped into another program for further processing.</p>

<h2 id="putting-it-all-together">Putting it all together</h2>

<p>With all the pieces in place we can now put the full version of the script together.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'open-uri'</span>
<span class="nb">require</span> <span class="s1">'nokogiri'</span>
<span class="nb">require</span> <span class="s1">'json'</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">'http://www.cubecinema.com/programme'</span>
<span class="n">html</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="n">doc</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">showings</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">doc</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'.showing'</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">showing</span><span class="o">|</span>
  <span class="n">showing_id</span> <span class="o">=</span> <span class="n">showing</span><span class="p">[</span><span class="s1">'id'</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="s1">'_'</span><span class="p">).</span><span class="nf">last</span><span class="p">.</span><span class="nf">to_i</span>
  <span class="n">tags</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'.tags a'</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">tag</span><span class="o">|</span> <span class="n">tag</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span> <span class="p">}</span>
  <span class="n">title_el</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'h1 a'</span><span class="p">)</span>
  <span class="n">title_el</span><span class="p">.</span><span class="nf">children</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">.</span><span class="nf">remove</span> <span class="k">if</span> <span class="n">c</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="s1">'span'</span> <span class="p">}</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">title_el</span><span class="p">.</span><span class="nf">text</span><span class="p">.</span><span class="nf">strip</span>
  <span class="n">dates</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.start_and_pricing'</span><span class="p">).</span><span class="nf">inner_html</span><span class="p">.</span><span class="nf">strip</span>
  <span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'&lt;br&gt;'</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">description</span> <span class="o">=</span> <span class="n">showing</span><span class="p">.</span><span class="nf">at_css</span><span class="p">(</span><span class="s1">'.copy'</span><span class="p">).</span><span class="nf">text</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">'[more...]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">).</span><span class="nf">strip</span>
  <span class="n">showings</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span>
    <span class="ss">id: </span><span class="n">showing_id</span><span class="p">,</span>
    <span class="ss">title: </span><span class="n">title</span><span class="p">,</span>
    <span class="ss">tags: </span><span class="n">tags</span><span class="p">,</span>
    <span class="ss">dates: </span><span class="n">dates</span><span class="p">,</span>
    <span class="ss">description: </span><span class="n">description</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">pretty_generate</span><span class="p">(</span><span class="n">showings</span><span class="p">)</span>
</code></pre></div></div>

<p>If you save the above into a file called <code class="highlighter-rouge">scraper.rb</code> and run it with <code class="highlighter-rouge">ruby scraper.rb</code> then you should see the JSON representation of the events printed to stdout. It will look something like the following.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">7686</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Harry Dean Stanton - Partly Fiction"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"dcp"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"film"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"ttt"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"dates"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"2015-01-19T20:00:00+00:00"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"2015-01-20T20:00:00+00:00"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A mesmerizing, impressionistic portrait of the iconic actor in his intimate moments, with film clips from some of his 250 films and his own heart-breaking renditions of American folk songs. ..."</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">7519</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bang the Bore Audiovisual Spectacle: VA AA LR + Stephen Cornford + Seth Cooke"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"music"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"dates"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"2015-01-21T20:00:00+00:00"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"An evening of hacked TVs, 4 screen cinematic drone and electroacoustics. VAAALR: Vasco Alves, Adam Asnan and Louie Rice create spectacles using distress flares, C02 and junk electronics. Stephen Cornford: ..."</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>And that’s it! This is just a basic example of scraping. Things get a bit more complicated if the site you’re scraping requires you to login first, for those instances I recommend looking into <a href="http://docs.seattlerb.org/mechanize/GUIDE_rdoc.html">mechanize</a>, which builds on top of Nokogiri.</p>

<p>Hopefully this introduction to scraping has given you some ideas for data that you want to turn into a more structured format using the scraping techniques described above.</p>

<div class="footnotes">
  <ol>
    <li id="fn:open-uri">
      <p>While good for basic tasks like this, open-uri has <a href="https://bugs.ruby-lang.org/issues/3719">some issues</a> which mean you may want to look elsewhere for an http client to use in production. <a href="#fnref:open-uri" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <p class="permalink"><a href="/2015/01/19/web-scraping-with-ruby/">Permalink</a></p>
</article>

<article class="post">

  <header class="post-header">
    <h2 class="post-title"><a href="/2014/04/12/banana-bread.markdown/">Banana Bread</a></h2>
    <p class="post-date">Saturday 12 April 2014</p>
  </header>

  <div class="post-content">
    
<p>My minimal banana bread recipe. This is very much at the bread end of the bread/cake spectrum, it’s not very sweet other than the sweetness from the banana. If you want more sweetness then you can add some sugar, soft brown if possible, up to 100g added after the butter. Recipe can be used as a base and then added to, for example after mixing in the flour you could add a handful of walnuts or raisins, some cinnamon, vanilla essence, honey, peanut butter etc, anything that might go with banana really!</p>

<h2 id="ingredients">Ingredients</h2>

<ul>
  <li>2 eggs</li>
  <li>100g butter</li>
  <li>2 ripe bananas</li>
  <li>200g self-raising flour</li>
</ul>

<h2 id="method">Method</h2>

<ol>
  <li>Preheat the oven to 180C (160C fan).</li>
  <li>Grease a loaf tin roughly 21x9x7cm and line with baking parchment</li>
  <li>Put the eggs into a large bowl and whisk them</li>
  <li>Melt the butter then combine with the eggs and mix thoroughly.</li>
  <li>Mash the bananas and fold them into the butter and egg mixture.</li>
  <li>Add the flour and mix until just combined. If the mixture is too loose then add more flour.</li>
  <li>Spoon into the tin and bake for about 40 minutes until a skewer inserted into the middle comes out clean.</li>
  <li>Cool in the tin for 10 minutes before turning out on to a rack to cool completely.</li>
</ol>

  </div>

  <p class="permalink"><a href="/2014/04/12/banana-bread.markdown/">Permalink</a></p>
</article>


<div class="pagination">

  
  <a href="/page5" class="previous">
    &larr; Newer posts
  </a>
  

  <span class="page_number">
    Page 6 of 8
  </span>

  
  <a href="/page7" class="next">
    Older posts &rarr;
  </a>
  

</div>

<p class="rss-subscribe">subscribe <a href="/index.xml">via RSS</a></p>

      </main>
    </div>

    <footer class="container site-footer">
      <a href="/" class="avatar-link"><img class="avatar" alt="chrismytton" width="100" height="100" data-proofer-ignore="true" src="https://avatars0.githubusercontent.com/chrismytton?v=3&s=100" srcset="https://avatars0.githubusercontent.com/chrismytton?v=3&s=100 1x, https://avatars0.githubusercontent.com/chrismytton?v=3&s=200 2x, https://avatars0.githubusercontent.com/chrismytton?v=3&s=300 3x, https://avatars0.githubusercontent.com/chrismytton?v=3&s=400 4x" /></a>
      <h3><a class="logo" href="/">Chris Mytton</a></h3>
      <p class="footer-links">
        Explore:
        <a href="/archive/">Archive</a> &middot;
        <a href="/tags/">Tags</a>
      </p>
      <p class="footer-links">
        Elsewhere:
        <a href="https://twitter.com/chrismytton">Twitter</a> &middot;
        <a href="https://github.com/chrismytton">GitHub</a>
      </p>
      <p class="footer-links">
        Contact:
        <a href="mailto:chrismytton@gmail.com">Email</a>
      </p>
      <p>
      I'm a Developer at <a href="https://www.mysociety.org/">mySociety</a>.
      This is my personal website.
      </p>
    </footer>

  </body>

</html>
